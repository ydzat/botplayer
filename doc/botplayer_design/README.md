# BotPlayer 插件设计文档

## 概述

BotPlayer 是为 LangBot 项目开发的音频播放插件，专门用于在 Discord 语音频道中播放音乐。该插件依赖 Discord 适配器提供的基础语音连接服务，专注于音乐播放的业务逻辑实现。

## 设计原则

### 职责分离
- **专注音乐播放**: 只负责音乐播放相关的业务逻辑
- **依赖适配器**: 使用 Discord 适配器提供的基础语音接口
- **模块化设计**: 各功能组件独立，便于维护和扩展
- **用户体验**: 提供友好的音乐播放交互界面

### 架构设计
- **插件系统**: 基于 LangBot 插件架构
- **异步处理**: 使用异步编程模型
- **配置驱动**: 支持灵活的配置管理
- **扩展性**: 支持多种音频源和播放模式

## 项目结构

```
plugins/botplayer/
├── doc/
│   ├── README.md                    # 项目总览
│   ├── architecture.md              # 架构设计
│   ├── botplayer_design/           # BotPlayer 插件设计
│   │   ├── api-design.md           # API 设计
│   │   ├── architecture.md         # 插件架构
│   │   ├── complete-design.md      # 完整设计
│   │   ├── implementation.md       # 实现细节
│   │   └── requirements.md         # 需求分析
│   └── discord_adapter_enh/        # Discord 适配器扩展
│       ├── README.md               # 适配器文档
│       ├── api-design.md           # 适配器API
│       ├── architecture.md         # 适配器架构
│       ├── implementation.md       # 适配器实现
│       └── requirements.md         # 适配器需求
├── src/
│   ├── __init__.py
│   ├── plugin.py                   # 插件主文件
│   ├── audio_manager.py           # 音频管理器
│   ├── queue_manager.py           # 播放队列管理
│   ├── search_engine.py           # 音频搜索引擎
│   ├── command_handler.py         # 命令处理器
│   └── utils.py                   # 工具函数
├── config/
│   └── config.yaml                # 插件配置
└── tests/
    ├── test_botplayer.py          # 插件单元测试
    ├── test_audio_manager.py      # 音频管理测试
    └── test_queue_manager.py      # 队列管理测试
```

## 主要功能

### 核心功能
- **音频播放**: 支持多种来源的音频播放（YouTube、Spotify、本地文件等）
- **播放控制**: 播放、暂停、停止、跳过等基础控制
- **队列管理**: 音频播放队列的添加、删除、排序
- **音频搜索**: 通过关键词搜索在线音频内容

### 扩展功能
- **音量控制**: 调节播放音量
- **循环模式**: 单曲循环、列表循环、随机播放
- **播放历史**: 记录和管理播放历史
- **音频信息**: 显示正在播放的音频信息
- **权限控制**: 基于角色的播放权限管理

### 用户交互
- **命令系统**: 支持自然语言和快捷命令
- **状态显示**: 实时显示播放状态和队列信息
- **交互按钮**: 提供快捷操作按钮
- **进度显示**: 显示播放进度和剩余时间

## 技术架构

### 依赖关系
- **LangBot 核心**: 插件系统、消息处理、配置管理
- **Discord 适配器**: 基础语音连接服务
- **外部库**: yt-dlp、spotipy、FFmpeg

### 核心组件
- **音频管理器**: 负责音频源处理和播放控制
- **队列管理器**: 管理播放队列和播放逻辑
- **搜索引擎**: 处理音频搜索和源解析
- **命令处理器**: 解析用户命令和执行操作
- **配置管理器**: 处理插件配置和设置

## 与适配器的协作

### 接口调用
- **语音连接**: 调用适配器的连接管理接口
- **状态查询**: 获取语音连接状态信息
- **错误处理**: 处理适配器返回的连接错误

### 职责分工
- **适配器提供**: 语音连接、连接状态、语音客户端
- **插件负责**: 音频播放、队列管理、用户交互、搜索功能

## 配置管理

### 基础配置
- 插件启用/禁用设置
- 默认音量和音质设置
- 播放权限配置

### 平台配置
- YouTube API 密钥
- Spotify API 密钥
- 其他音频平台配置

### 用户配置
- 个性化设置
- 播放偏好
- 权限配置

## 性能优化

### 音频处理
- 音频缓存策略
- 流式播放支持
- 格式转换优化

### 资源管理
- 内存使用优化
- 网络连接管理
- 并发控制

## 错误处理

### 异常类型
- 网络连接异常
- 音频格式异常
- 权限验证异常
- 播放器状态异常

### 处理策略
- 自动错误恢复
- 友好错误提示
- 降级播放策略
- 日志记录和监控

## 兼容性

- 支持 Python 3.8+
- 兼容主流音频格式
- 跨平台支持
- Docker 容器支持

## 安全考虑

- 音频源 URL 验证
- 文件路径安全检查
- 用户权限控制
- 资源使用限制
- 内容过滤机制
