# Discord 音乐播放器插件设计文档

## 概述

Discord 音乐播放器插件 (BotPlayer) 是为 LangBot 项目开发的音频播放功能扩展。该插件基于现有的 `pkg/platform/sources/discord.py` Discord 适配器进行扩展，添加语音频道连接和音频播放功能，同时保持与现有消息处理系统的完全兼容。

## 架构设计

### 分离式设计架构
- **Discord 适配器扩展**: 在现有 `DiscordAdapter` 类基础上添加基础语音连接功能
- **BotPlayer 插件**: 作为独立插件实现所有音乐播放业务逻辑
- **清晰职责分离**: 适配器只负责连接，插件负责业务

### 项目结构

```
plugins/botplayer/
├── doc/
│   ├── README.md                        # 本文档
│   ├── architecture.md                  # Discord 适配器语音扩展架构
│   ├── discord_adapter_enh/             # Discord 适配器扩展文档
│   │   └── api-design.md               # 适配器基础语音 API 设计
│   └── botplayer_design/               # BotPlayer 插件设计文档
│       ├── api-design.md               # 插件 API 设计
│       ├── architecture.md             # 插件架构设计
│       └── complete-design.md          # 插件完整设计
├── src/
│   ├── __init__.py
│   ├── plugin.py                       # 插件主文件
│   ├── audio_manager.py                # 音频管理器
│   ├── playback_controller.py          # 播放控制器
│   ├── queue_manager.py                # 播放队列管理
│   └── command_handler.py              # 命令处理器
├── config/
│   └── config.yaml                     # 插件配置
└── tests/
    └── test_botplayer.py               # 单元测试
```

## 主要功能

### 核心功能
- **语音频道管理**: 加入/离开语音频道，连接状态管理
- **音频播放**: 支持在线音频（YouTube、Spotify等）和本地文件
- **播放控制**: 播放、暂停、停止、跳过等基础控制
- **音频搜索**: 通过关键词搜索音频内容

### 扩展功能
- **播放队列**: 完整的队列管理系统（添加、移除、排序）
- **音量控制**: 实时音量调节
- **循环模式**: 单曲循环、列表循环、随机播放
- **播放历史**: 记录和管理播放历史
- **状态显示**: 实时播放状态和进度信息

## 技术架构

### 核心组件

#### 1. Discord 适配器基础语音扩展 (`pkg/platform/sources/discord.py`)
- **职责**: 仅提供基础语音连接和断开功能
- **不包含**: 任何音乐播放业务逻辑
- **提供的API**: `join_voice_channel()`, `leave_voice_channel()`, `get_voice_client()`

#### 2. BotPlayer 插件 (`plugins/botplayer/`)
- **音频管理器**: 处理音频源、格式转换、信息提取
- **播放控制器**: 使用适配器的语音客户端控制播放
- **队列管理器**: 管理播放队列和播放逻辑
- **命令处理器**: 解析和执行用户命令

### 依赖关系
- **LangBot 核心**: 插件系统、命令处理、事件管理
- **Discord 适配器基础语音**: 语音连接、语音客户端获取
- **外部库**: discord.py[voice] (语音功能)、yt-dlp (在线音频)、FFmpeg (音频处理)

### 设计原则
1. **职责分离**: 适配器只负责连接，插件负责业务逻辑
2. **最小侵入**: 对现有 Discord 适配器的修改最小化
3. **模块解耦**: 插件组件之间通过清晰接口交互
4. **向后兼容**: 保持所有现有功能不受影响

## 用户交互

### 命令系统
- **基于 LangBot**: 使用现有的命令处理机制
- **自然语言**: 支持自然语言命令解析
- **权限控制**: 集成现有的权限管理系统

### 反馈机制
- **即时响应**: 命令执行结果即时反馈
- **状态更新**: 播放状态变化主动通知
- **错误处理**: 友好的错误信息和解决建议

## 部署和配置

### 系统要求
- **Python 3.8+**: 与 LangBot 核心版本要求一致
- **FFmpeg**: 音频处理必需
- **网络连接**: 在线音频播放需要稳定网络
- **Discord 权限**: 机器人需要语音频道相关权限

### 配置集成
- **Discord 配置扩展**: 在现有 Discord 适配器配置中添加音频选项
- **插件配置**: 独立的插件配置文件
- **热重载支持**: 配置更改无需重启

## 兼容性保证

### 现有功能
- **消息处理**: 完全保持现有的消息处理功能
- **其他适配器**: 不影响其他平台适配器的正常运行
- **插件系统**: 与现有插件系统完全兼容

### 可选性
- **功能开关**: 音频功能可以通过配置禁用
- **依赖可选**: 音频相关依赖作为可选安装
- **降级支持**: 在不支持音频的环境中优雅降级

## 安全考虑

### 访问控制
- **权限集成**: 使用 LangBot 现有的权限系统
- **资源限制**: 防止音频功能被滥用
- **内容过滤**: 支持有害内容过滤

### 数据保护
- **隐私保护**: 不存储敏感用户信息
- **数据清理**: 支持播放历史自动清理
- **安全传输**: 确保数据传输安全
